<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Chat App Dashboard</title>
    <link rel="shortcut icon" href="#">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            background-color: whitesmoke;
        }

        .messageDiv {
            display: flex;
            flex-direction: column;
            /* Allow the list to grow vertically */
            justify-content: center;
            align-items: center;
            background-color: aquamarine;
            margin-left: auto;
            margin-right: auto;
            width: 40%;
            padding: 10px;
            /* Add some padding for spacing */
        }

        #messageList {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        #messageList li {
            padding: 5px;
            margin-bottom: 5px;
            list-style: none;
            background-color: white;
            /* Background for each item */
            border-radius: 5px;
            /* Optional: rounded corners */
        }

        .succesMessage {
            background-color: rgb(0, 255, 0, 0.5);
            margin: 20px;
            padding: 5px;
        }

        .failureMessage {
            /* background-color: red; */
            background-color: rgba(255, 0, 0, 0.5);
            margin: 20px;
            padding: 5px;
        }

        .formDiv {
            margin: 20px;
            padding: 5px;
            background-color: bisque;
            height: 30px;
            margin-top: 10px;
            display: flex;
            align-items: center;
        }

        button {
            margin: 5px;
            padding: 5px;
            border-radius: 6px;
            cursor: pointer;
        }

        button:hover {
            background-color: #ff9d29;
        }

        #userInputChat {
            padding: 5px;
            margin: 20px;
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h2>Chat App</h2>
    </header>

    <div class="formDiv">
        <form onsubmit="submitChat(event)">
            <label for="chat">Enter Chat</label>
            <input type="text" id="userInputChat">
            <button type="submit">Send Chat</button>
        </form>
    </div>

    <div class="messageDiv">
        <ul id="messageList">
        </ul>
    </div>
    <div id="message">

    </div>

    <script>
        //global
        const HOST = 'localhost';
        const chatList = document.getElementById('messageList');
        let lastChatId = 0;

        //function to display the message
        function showMessage(msgText, className) {
            const msg = document.getElementById('message');
            const div = document.createElement('div');
            const textNode = document.createTextNode(msgText);
            div.appendChild(textNode);
            msg.appendChild(div);
            msg.classList.add(className);

            setTimeout(() => {
                msg.classList.remove(className);
                msg.removeChild(div);
            }, 2000);
        }

        function printChatDataOnFrontend(data) {
            console.log('inside printChatDataOnFrontend...');
            console.log("chat = " + data.chatName);
            const li = document.createElement('li');
            li.appendChild(document.createTextNode(data.chatName));
            chatList.appendChild(li);

            lastChatId = data.id; // Update the lastChatId to the latest chat
        }

        async function fetchData() {
            console.log('inside fetchData...');
            let token = localStorage.getItem('token');
            console.log('token = ' + token);
            if (!token) {
                console.log("Token not found. Please log in.");
                return;
            }

            try {
                const response = await axios.get(`http://${HOST}:3000/userLogin/chat`, {
                    headers: {
                        "Authorization": token
                    }
                });
                const chatData = response.data.allChatData;
                console.log('response = ' + JSON.stringify(chatData));

                for (let i = 0; i < chatData.length; i++) {
                    if (chatData[i].id > lastChatId) {
                        printChatDataOnFrontend(chatData[i]);
                    }
                }
            }
            catch (err) {
                console.log("fetchData error = " + err);
            }
        }

        async function submitChat(event) {
            event.preventDefault();
            console.log('inside submitChat');
            let userChat = document.getElementById('userInputChat');
            console.log('userChat = ' + userChat.value);
            let token = localStorage.getItem('token');
            console.log('token = ' + token);

            if (userChat.value == "") {
                console.log("Empty user fields");
            }
            else {

                try {
                    const obj = {
                        chat: userChat.value,
                    }
                    const response = await axios.post(`http://${HOST}:3000/userLogin/chat`, obj, {
                        headers: {
                            "Authorization": token
                        }
                    });
                    // Log the response for debugging
                    console.log('response = ' + JSON.stringify(response.data.chatData));
                    // console.log('name = ' + response.data.chatData);

                    showMessage(response.data.message, 'succesMessage');

                    const li = document.createElement('li');
                    li.appendChild(document.createTextNode(response.data.chatData.chatName));
                    chatList.appendChild(li);
                }
                catch (error) {
                    console.log('Error object:', error);
                    showMessage(error.response.data.message, 'failureMessage');
                }
            }
            userChat.value = "";
        }

        setInterval(fetchData, 5000);

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>

</html>